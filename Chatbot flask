from flask import Flask, jsonify
import serial
import json
import threading

app = Flask(__name__)

# Configure the serial port and baud rate
ser = serial.Serial('COM5', 9600)  # Update with your actual serial port

# Global variable to store the latest data
latest_data = {'t': 25, 'h': 50}

def read_serial_data():
    """Continuously read data from the serial port and update latest_data."""
    global latest_data
    while True:
        if ser.in_waiting > 0:
            line = ser.readline().decode('utf-8').strip()
            try:
                data = json.loads(line)
                latest_data = data
            except json.JSONDecodeError:
                continue

# Start the serial reading thread
threading.Thread(target=read_serial_data, daemon=True).start()

@app.route('/temperature', methods=['GET'])
def get_temperature():
    temperature = latest_data.get('t', 25)  # Default to 25 if no data
    humidity = latest_data.get('h', 50)  # Default to 50 if no data

    # Prepare response in JSON format
    response = {
        'temperature': temperature,
        'humidity': humidity
    }

    return jsonify(response)

if __name__ == '__main__':
    app.run(debug=True)
